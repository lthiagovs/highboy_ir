#include "ir_manager.h"
#include "ir_path.h"
#include "ir_receiver.h"
#include "esp_log.h"

#define TAG 

void app_main() {

    if (ir_path_init() != IR_PATH_OK) {
        ESP_LOGE("MAIN", "Failed to initialize SD card");
        return;
    }

    ir_manager_init();

    // Alocar dynamicamente para evitar stack overflow
    rmt_symbol_word_t* symbols = malloc(sizeof(rmt_symbol_word_t) * MEM_BLOCK_SYMBOLS);
    size_t received = 0;
    if (!symbols) {
        ESP_LOGE("MAIN", "Falha ao alocar memória para symbols");
        return;
    }

    // Função de recepção
    if (ir_manager_init_storage()) {
        //ir_manager_receive(symbols);

        if (rmt_rx_receive_once(symbols, MEM_BLOCK_SYMBOLS, &received)) {
        ESP_LOGI("MAIN", "Recebido %d símbolos IR", (int)received);
        } else {
            ESP_LOGW("MAIN", "Timeout - nenhum sinal recebido");
        }

        ir_manager_list_files();
        ir_manager_deinit_storage();
    }

    free(symbols);

    ir_path_deinit();
}
